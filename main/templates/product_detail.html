{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Product Detail - Bolapedia</title>
{% endblock meta %}

{% block content %}

<div class="bg-white">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 sm:py-16">
    
    <nav class="mb-8 text-sm font-medium text-slate-500">
      <a href="{% url 'main:show_main' %}" class="hover:text-slate-700">Products</a>
      <span class="mx-2">/</span>
      <span id="breadcrumb-name">Loading...</span>
    </nav>  

    <div id="loading-state" class="text-center py-20">
        <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
        </svg>
        <p class="text-slate-600 mt-4">Loading product details...</p>
    </div>

    <div id="error-state" class="hidden text-center py-16 px-6 border-2 border-dashed border-red-300 rounded-xl">
        <div class="text-red-500 text-5xl mb-4">‚ö†Ô∏è</div>
        <h3 class="text-xl font-semibold text-red-800">Failed to Load Product</h3>
        <p class="text-slate-500 mt-2">The requested product could not be found or an error occurred.</p>
    </div>
    
    <div id="product-content-wrapper" class="hidden">
        </div>
    
  </div>
</div>

<script>
// --- KONFIGURASI ---
const PRODUCT_ID = "{{ product.id }}";
const PRODUCT_DETAIL_ENDPOINT = `{% url 'main:show_json_by_id' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', PRODUCT_ID);
const CURRENT_USER_ID = "{{ user.id|default_if_none:'' }}";

// --- ELEMEN DOM ---
const loadingState = document.getElementById('loading-state');
const errorState = document.getElementById('error-state');
const productContentWrapper = document.getElementById('product-content-wrapper');

// --- FUNGSI TAMPILAN (UI) ---
function showState(state) {
    loadingState.classList.toggle('hidden', state !== 'loading');
    errorState.classList.toggle('hidden', state !== 'error');
    productContentWrapper.classList.toggle('hidden', state !== 'ready');
}

function getReadableCategoryName(categoryCode) {
    const categoryMapping = {
        'baju': 'Baju', 'celana': 'Celana', 'sepatu': 'Sepatu', 'topi': 'Topi',
        'kaus kaki': 'Kaus Kaki', 'sarung tangan': 'Sarung Tangan', 'lainnya': 'Lainnya'
    };
    return categoryMapping[categoryCode] || categoryCode;
}

// --- FUNGSI RENDER UTAMA ---
function renderProduct(product) {
    // Set judul halaman dan breadcrumb
    document.title = `${product.name} - Bolapedia`;
    document.getElementById('breadcrumb-name').textContent = product.name;

    // Siapkan semua data yang dibutuhkan
    const formattedPrice = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(product.price);
    const linkEdit = `{% url 'main:edit_product' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', product.id);
    const linkDelete = `{% url 'main:delete_product' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', product.id);

    const imageHtml = product.thumbnail
        ? `<img src="${product.thumbnail}" alt="${product.name}" class="w-full h-full object-cover">`
        : `<div class="w-full h-full flex items-center justify-center text-5xl text-slate-400">‚öΩ</div>`;

    const badgesHtml = `
        <span class="px-3 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-800">
            ${getReadableCategoryName(product.category)}
        </span>
        ${product.is_featured ? `
        <span class="px-3 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800">‚≠ê Featured</span>` : ''}
    `;

    const actionButtonsHtml = (CURRENT_USER_ID && Number(CURRENT_USER_ID) === Number(product.user_id))
        ? `<div class="flex items-center gap-x-3">
               <a href="${linkEdit}" class="flex-1 text-center px-5 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition">Edit Product</a>
               <a href="${linkDelete}" onclick="return confirm('Are you sure?')" class="px-4 py-3 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition">üóëÔ∏è</a>
           </div>`
        : `<a href="#" class="block w-full text-center px-5 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition">Add to Cart</a>`;

    // Bangun seluruh struktur Grid di dalam JavaScript
    const productGridHtml = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-10 lg:gap-16">
            <div>
                <div class="aspect-square bg-slate-100 rounded-xl overflow-hidden border">
                    ${imageHtml}
                </div>
            </div>
            <div class="flex flex-col">
                <div class="flex items-center gap-x-2 mb-3">
                    ${badgesHtml}
                </div>
                <h1 class="text-3xl lg:text-4xl font-extrabold text-slate-900 tracking-tight">${product.name}</h1>
                <p class="mt-2 text-sm text-slate-500">
                    Posted by <span class="font-medium text-slate-700">${product.user_username || 'N/A'}</span>
                </p>
                <p class="mt-4 text-3xl font-bold text-blue-600">${formattedPrice}</p>
                <p class="mt-4 text-slate-600 leading-relaxed">${product.description}</p>
                <div class="mt-6 pt-6 border-t border-slate-200">
                    <dl class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                        <div>
                            <dt class="font-medium text-slate-500">Brand</dt>
                            <dd class="text-slate-800 font-semibold">${product.brand || 'N/A'}</dd>
                        </div>
                        <div>
                            <dt class="font-medium text-slate-500">Stock</dt>
                            <dd class="text-slate-800 font-semibold">${product.stock}</dd>
                        </div>
                    </dl>
                </div>
                <div class="mt-auto pt-8">
                    ${actionButtonsHtml}
                </div>
            </div>
        </div>
    `;

    // Masukkan seluruh HTML yang sudah jadi ke dalam wadah
    productContentWrapper.innerHTML = productGridHtml;
}

// --- FUNGSI FETCH DATA ---
async function loadProductDetail() {
    try {
        showState('loading');
        
        const response = await fetch(PRODUCT_DETAIL_ENDPOINT);

        if (!response.ok) {
            throw new Error('Product not found or server error');
        }

        const productData = await response.json();
        renderProduct(productData);
        showState('ready');
    } catch (error) {
        console.error('Error loading product detail:', error);
        showState('error');
    }
}

// --- INISIALISASI ---
loadProductDetail();

</script>
{% endblock content %}